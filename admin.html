<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MESMTF — Admin Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in { animation: fadeIn .3s ease-in; }
    @keyframes fadeIn { from {opacity:0; transform:translateY(6px);} to {opacity:1; transform:translateY(0);} }
    .pill { display:inline-block; padding:.25rem .6rem; border-radius:999px; background:#eef2ff; color:#312e81; font-size:.8rem; }
    .small { font-size:.85rem; }
    .status-active { background:#d1fae5; color:#065f46; }
    .status-inactive { background:#fee2e2; color:#991b1b; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

  <!-- Top nav -->
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto flex items-center justify-between p-4">
      <div class="flex items-center space-x-4">
        <div class="rounded-full bg-gray-700 w-12 h-12 flex items-center justify-center text-white font-bold">A</div>
        <div>
          <div class="text-lg font-bold text-gray-800">MESMTF Admin Portal</div>
          <div class="text-sm text-gray-500">Medical Expert System — Malaria & Typhoid</div>
        </div>
      </div>
      <div class="flex items-center space-x-4">
        <div class="text-sm text-gray-700">Admin User • <span class="text-xs text-gray-500">Administrator</span></div>
        <button id="dashboardBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded mr-2">Dashboard</button>
        <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">Logout</button>
      </div>
    </div>
  </header>

  <div class="max-w-7xl mx-auto mt-6 flex gap-6 px-4">
    <!-- Sidebar -->
    <aside class="w-72 bg-white rounded-lg shadow p-4 sticky top-6 h-[calc(100vh-96px)]">
      <nav class="space-y-1">
        <button id="nav-dashboard" class="w-full text-left px-3 py-2 rounded hover:bg-gray-50" onclick="render('dashboard')">🏠 Dashboard</button>
        <button id="nav-users" class="w-full text-left px-3 py-2 rounded hover:bg-gray-50" onclick="render('users')">👥 User Management</button>
        <button id="nav-system" class="w-full text-left px-3 py-2 rounded hover:bg-gray-50" onclick="render('system')">⚙️ System Settings</button>
        <button id="nav-analytics" class="w-full text-left px-3 py-2 rounded hover:bg-gray-50" onclick="render('analytics')">📊 Analytics</button>
        <button id="nav-database" class="w-full text-left px-3 py-2 rounded hover:bg-gray-50" onclick="render('database')">🗄️ Database</button>
      </nav>
    </aside>

    <!-- Main content -->
    <main id="mainContent" class="flex-1 min-h-[70vh] bg-white rounded-lg shadow p-6 fade-in">
    </main>
  </div>

  <script>
  // -------------------------
  // Data
  // -------------------------
  let users = JSON.parse(localStorage.getItem('admin_users')) || [
    { id: 'u1', username: 'admin', name: 'System Administrator', role: 'admin', email: 'admin@moh.gov', status: 'active', lastLogin: new Date().toISOString() },
    { id: 'u2', username: 'dr.smith', name: 'Dr. John Smith', role: 'doctor', email: 'j.smith@moh.gov', status: 'active', lastLogin: new Date(Date.now() - 86400000).toISOString() },
    { id: 'u3', username: 'nurse.jane', name: 'Jane Doe', role: 'nurse', email: 'j.doe@moh.gov', status: 'active', lastLogin: new Date(Date.now() - 172800000).toISOString() },
    { id: 'u4', username: 'pharm.mike', name: 'Mike Johnson', role: 'pharmacist', email: 'm.johnson@moh.gov', status: 'active', lastLogin: new Date(Date.now() - 259200000).toISOString() },
    { id: 'u5', username: 'recep.mary', name: 'Mary Wilson', role: 'receptionist', email: 'm.wilson@moh.gov', status: 'inactive', lastLogin: new Date(Date.now() - 604800000).toISOString() }
  ];
  
  let systemSettings = JSON.parse(localStorage.getItem('admin_settings')) || {
    hospitalName: 'Ministry of Health Hospital',
    location: 'Windhoek, Namibia',
    contactEmail: 'info@moh.gov',
    contactPhone: '+264 61 123 4567',
    workingHours: '08:00 - 17:00',
    emergencyContact: '+264 81 123 4567',
    systemMaintenance: false,
    backupFrequency: 'daily'
  };
  
  let systemLogs = JSON.parse(localStorage.getItem('admin_logs')) || [
    { id: 'l1', type: 'info', message: 'System started', timestamp: new Date().toISOString(), user: 'system' },
    { id: 'l2', type: 'warning', message: 'Low disk space on server', timestamp: new Date(Date.now() - 3600000).toISOString(), user: 'system' },
    { id: 'l3', type: 'info', message: 'User dr.smith logged in', timestamp: new Date(Date.now() - 7200000).toISOString(), user: 'dr.smith' },
    { id: 'l4', type: 'error', message: 'Failed to backup database', timestamp: new Date(Date.now() - 86400000).toISOString(), user: 'system' }
  ];
  
  function save(){ 
    localStorage.setItem('admin_users', JSON.stringify(users)); 
    localStorage.setItem('admin_settings', JSON.stringify(systemSettings)); 
    localStorage.setItem('admin_logs', JSON.stringify(systemLogs)); 
  }

  function uid(prefix){ return prefix+'-'+Math.floor(Date.now()+Math.random()*1000); }
  function fmtDate(d){ return new Date(d).toLocaleString(); }

  // -------------------------
  // Dashboard
  // -------------------------
  function renderDashboard(){
    const activeUsers = users.filter(u => u.status === 'active').length;
    const todayLogins = users.filter(u => {
      const loginDate = new Date(u.lastLogin);
      const today = new Date();
      return loginDate.toDateString() === today.toDateString();
    }).length;
    
    const errorLogs = systemLogs.filter(l => l.type === 'error').length;
    
    document.getElementById('mainContent').innerHTML = `
      <h2 class="text-2xl font-bold mb-4">Admin Dashboard</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white p-4 rounded shadow border-l-4 border-blue-500">
          <h3 class="text-sm text-gray-500">Active Users</h3>
          <div class="text-lg font-semibold mt-2">${activeUsers}</div>
        </div>
        <div class="bg-white p-4 rounded shadow border-l-4 border-green-500">
          <h3 class="text-sm text-gray-500">Today's Logins</h3>
          <div class="text-lg font-semibold mt-2">${todayLogins}</div>
        </div>
        <div class="bg-white p-4 rounded shadow border-l-4 border-red-500">
          <h3 class="text-sm text-gray-500">System Errors</h3>
          <div class="text-lg font-semibold mt-2">${errorLogs}</div>
        </div>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="font-semibold mb-3">Recent System Activity</h3>
          <div class="space-y-2 max-h-64 overflow-y-auto">
            ${systemLogs.slice(0, 5).map(log => `
              <div class="p-2 border rounded">
                <div class="flex justify-between">
                  <div class="font-medium ${log.type === 'error' ? 'text-red-600' : log.type === 'warning' ? 'text-yellow-600' : 'text-gray-600'}">
                    ${log.message}
                  </div>
                  <span class="text-xs text-gray-500">${new Date(log.timestamp).toLocaleTimeString()}</span>
                </div>
                <div class="text-xs text-gray-500 mt-1">By: ${log.user}</div>
              </div>
            `).join('')}
          </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="font-semibold mb-3">User Distribution by Role</h3>
          <div class="space-y-2">
            ${getUserDistribution().map(role => `
              <div class="flex justify-between p-2 border rounded">
                <div>${role.name}</div>
                <div class="font-semibold">${role.count} users</div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
      
      <div class="mt-6 bg-white rounded-lg shadow p-4">
        <h3 class="font-semibold mb-3">Quick Actions</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <button class="p-3 bg-blue-100 rounded text-center hover:bg-blue-200" onclick="render('users')">
            <div class="text-2xl mb-2">👥</div>
            <div>Manage Users</div>
          </button>
          <button class="p-3 bg-green-100 rounded text-center hover:bg-green-200" onclick="render('system')">
            <div class="text-2xl mb-2">⚙️</div>
            <div>System Settings</div>
          </button>
          <button class="p-3 bg-purple-100 rounded text-center hover:bg-purple-200" onclick="backupDatabase()">
            <div class="text-2xl mb-2">💾</div>
            <div>Backup Now</div>
          </button>
          <button class="p-3 bg-yellow-100 rounded text-center hover:bg-yellow-200" onclick="showSystemStatus()">
            <div class="text-2xl mb-2">📊</div>
            <div>System Status</div>
          </button>
        </div>
      </div>
    `;
  }

  function getUserDistribution() {
    const roleCounts = {};
    users.forEach(u => {
      roleCounts[u.role] = (roleCounts[u.role] || 0) + 1;
    });
    
    return Object.entries(roleCounts)
      .map(([role, count]) => ({ name: role.charAt(0).toUpperCase() + role.slice(1), count }))
      .sort((a, b) => b.count - a.count);
  }

  // -------------------------
  // User Management
  // -------------------------
  function renderUsers(){
    document.getElementById('mainContent').innerHTML = `
      <h2 class="text-2xl font-bold mb-4">User Management</h2>
      
      <div class="mb-4 flex justify-between">
        <input type="text" id="searchUsers" placeholder="Search users..." class="p-2 border rounded w-64">
        <button class="px-4 py-2 bg-green-600 text-white rounded" onclick="showAddUserForm()">Add New User</button>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white border">
          <thead>
            <tr class="bg-gray-100">
              <th class="py-2 px-4 border text-left">Username</th>
              <th class="py-2 px-4 border text-left">Name</th>
              <th class="py-2 px-4 border text-left">Role</th>
              <th class="py-2 px-4 border text-left">Email</th>
              <th class="py-2 px-4 border text-left">Status</th>
              <th class="py-2 px-4 border text-left">Last Login</th>
              <th class="py-2 px-4 border text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="usersTable">
            ${users.map(u => `
              <tr>
                <td class="py-2 px-4 border">${u.username}</td>
                <td class="py-2 px-4 border">${u.name}</td>
                <td class="py-2 px-4 border">${u.role}</td>
                <td class="py-2 px-4 border">${u.email}</td>
                <td class="py-2 px-4 border">
                  <span class="pill ${u.status === 'active' ? 'status-active' : 'status-inactive'}">
                    ${u.status}
                  </span>
                </td>
                <td class="py-2 px-4 border">${fmtDate(u.lastLogin)}</td>
                <td class="py-2 px-4 border">
                  <button class="text-blue-600 hover:underline mr-2" onclick="editUser('${u.id}')">Edit</button>
                  <button class="text-red-600 hover:underline" onclick="deleteUser('${u.id}')">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
    
    // Add search functionality
    document.getElementById('searchUsers').addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#usersTable tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });
  }

  // -------------------------
  // System Settings
  // -------------------------
  function renderSystem(){
    document.getElementById('mainContent').innerHTML = `
      <h2 class="text-2xl font-bold mb-4">System Settings</h2>
      
      <form id="systemSettingsForm" class="space-y-4 max-w-2xl">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Hospital Name</label>
            <input type="text" id="hospitalName" value="${systemSettings.hospitalName}" class="w-full p-2 border rounded">
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Location</label>
            <input type="text" id="location" value="${systemSettings.location}" class="w-full p-2 border rounded">
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Contact Email</label>
            <input type="email" id="contactEmail" value="${systemSettings.contactEmail}" class="w-full p-2 border rounded">
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Contact Phone</label>
            <input type="text" id="contactPhone" value="${systemSettings.contactPhone}" class="w-full p-2 border rounded">
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Working Hours</label>
            <input type="text" id="workingHours" value="${systemSettings.workingHours}" class="w-full p-2 border rounded">
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Emergency Contact</label>
            <input type="text" id="emergencyContact" value="${systemSettings.emergencyContact}" class="w-full p-2 border rounded">
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Backup Frequency</label>
            <select id="backupFrequency" class="w-full p-2 border rounded">
              <option value="hourly" ${systemSettings.backupFrequency === 'hourly' ? 'selected' : ''}>Hourly</option>
              <option value="daily" ${systemSettings.backupFrequency === 'daily' ? 'selected' : ''}>Daily</option>
              <option value="weekly" ${systemSettings.backupFrequency === 'weekly' ? 'selected' : ''}>Weekly</option>
            </select>
          </div>
          
          <div class="flex items-center">
            <input type="checkbox" id="systemMaintenance" ${systemSettings.systemMaintenance ? 'checked' : ''} class="mr-2">
            <label for="systemMaintenance" class="text-sm font-medium">System Maintenance Mode</label>
          </div>
        </div>
        
        <div class="pt-4">
          <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Save Settings</button>
          <button type="button" class="px-4 py-2 bg-gray-300 ml-2 rounded" onclick="resetSettings()">Reset to Defaults</button>
        </div>
      </form>
      
      <div class="mt-8">
        <h3 class="text-lg font-semibold mb-3">System Information</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="p-3 bg-gray-50 rounded">
            <div class="text-sm text-gray-500">System Version</div>
            <div class="font-medium">MESMTF v2.1.0</div>
          </div>
          <div class="p-3 bg-gray-50 rounded">
            <div class="text-sm text-gray-500">Last Backup</div>
            <div class="font-medium">${fmtDate(new Date())}</div>
          </div>
          <div class="p-3 bg-gray-50 rounded">
            <div class="text-sm text-gray-500">Database Size</div>
            <div class="font-medium">24.5 MB</div>
          </div>
          <div class="p-3 bg-gray-50 rounded">
            <div class="text-sm text-gray-500">Uptime</div>
            <div class="font-medium">15 days, 4 hours</div>
          </div>
        </div>
      </div>
    `;
    
    document.getElementById('systemSettingsForm').onsubmit = function(e) {
      e.preventDefault();
      
      systemSettings = {
        hospitalName: document.getElementById('hospitalName').value,
        location: document.getElementById('location').value,
        contactEmail: document.getElementById('contactEmail').value,
        contactPhone: document.getElementById('contactPhone').value,
        workingHours: document.getElementById('workingHours').value,
        emergencyContact: document.getElementById('emergencyContact').value,
        backupFrequency: document.getElementById('backupFrequency').value,
        systemMaintenance: document.getElementById('systemMaintenance').checked
      };
      
      save();
      alert('System settings updated successfully');
      
      // Add to system logs
      systemLogs.unshift({
        id: uid('l'),
        type: 'info',
        message: 'System settings updated',
        timestamp: new Date().toISOString(),
        user: 'admin'
      });
      save();
    };
  }

  // -------------------------
  // Analytics
  // -------------------------
  function renderAnalytics(){
    // Simulate some analytics data
    const monthlyPatients = 245;
    const malariaCases = 167;
    const typhoidCases = 78;
    const avgTreatmentDays = 4.2;
    
    document.getElementById('mainContent').innerHTML = `
      <h2 class="text-2xl font-bold mb-4">System Analytics</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-white p-4 rounded shadow">
          <h3 class="text-sm text-gray-500">Monthly Patients</h3>
          <div class="text-lg font-semibold mt-2">${monthlyPatients}</div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <h3 class="text-sm text-gray-500">Malaria Cases</h3>
          <div class="text-lg font-semibold mt-2">${malariaCases}</div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <h3 class="text-sm text-gray-500">Typhoid Cases</h3>
          <div class="text-lg font-semibold mt-2">${typhoidCases}</div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <h3 class="text-sm text-gray-500">Avg Treatment Days</h3>
          <div class="text-lg font-semibold mt-2">${avgTreatmentDays}</div>
        </div>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="font-semibold mb-3">Disease Distribution</h3>
          <div class="h-64 flex items-center justify-center bg-gray-50 rounded">
            <div class="text-center">
              <div class="text-lg font-semibold">Malaria: ${Math.round(malariaCases/(malariaCases+typhoidCases)*100)}%</div>
              <div class="text-lg font-semibold">Typhoid: ${Math.round(typhoidCases/(malariaCases+typhoidCases)*100)}%</div>
              <div class="text-sm text-gray-500 mt-2">Based on ${malariaCases + typhoidCases} diagnosed cases</div>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="font-semibold mb-3">User Activity</h3>
          <div class="space-y-2">
            ${users.slice(0, 5).map(u => `
              <div class="flex justify-between p-2 border rounded">
                <div>${u.name}</div>
                <div class="text-sm text-gray-500">Last login: ${new Date(u.lastLogin).toLocaleDateString()}</div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
      
      <div class="mt-6 bg-white rounded-lg shadow p-4">
        <h3 class="font-semibold mb-3">Export Reports</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <button class="p-3 bg-blue-100 rounded text-center hover:bg-blue-200" onclick="exportReport('patients')">
            <div class="text-2xl mb-2">👥</div>
            <div>Patient Data</div>
          </button>
          <button class="p-3 bg-green-100 rounded text-center hover:bg-green-200" onclick="exportReport('treatment')">
            <div class="text-2xl mb-2">📊</div>
            <div>Treatment Stats</div>
          </button>
          <button class="p-3 bg-purple-100 rounded text-center hover:bg-purple-200" onclick="exportReport('system')">
            <div class="text-2xl mb-2">⚙️</div>
            <div>System Logs</div>
          </button>
        </div>
      </div>
    `;
  }

  // -------------------------
  // Database Management
  // -------------------------
  function renderDatabase(){
    document.getElementById('mainContent').innerHTML = `
      <h2 class="text-2xl font-bold mb-4">Database Management</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="font-semibold mb-3">Backup Operations</h3>
          <div class="space-y-3">
            <button class="w-full p-3 bg-blue-100 rounded text-center hover:bg-blue-200" onclick="backupDatabase()">
              <div class="text-lg font-semibold">Create Backup</div>
              <div class="text-sm text-gray-600">Backup all system data</div>
            </button>
            <button class="w-full p-3 bg-green-100 rounded text-center hover:bg-green-200" onclick="restoreDatabase()">
              <div class="text-lg font-semibold">Restore Backup</div>
              <div class="text-sm text-gray-600">Restore from previous backup</div>
            </button>
          </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="font-semibold mb-3">Database Information</h3>
          <div class="space-y-2">
            <div class="flex justify-between">
              <div>Total Records</div>
              <div class="font-semibold">12,458</div>
            </div>
            <div class="flex justify-between">
              <div>Database Size</div>
              <div class="font-semibold">24.5 MB</div>
            </div>
            <div class="flex justify-between">
              <div>Last Backup</div>
              <div class="font-semibold">${fmtDate(new Date())}</div>
            </div>
            <div class="flex justify-between">
              <div>Backup Frequency</div>
              <div class="font-semibold">${systemSettings.backupFrequency}</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow p-4">
        <h3 class="font-semibold mb-3">System Logs</h3>
        <div class="max-h-64 overflow-y-auto">
          <table class="min-w-full bg-white">
            <thead class="sticky top-0 bg-gray-100">
              <tr>
                <th class="py-2 px-4 text-left">Time</th>
                <th class="py-2 px-4 text-left">Type</th>
                <th class="py-2 px-4 text-left">Message</th>
                <th class="py-2 px-4 text-left">User</th>
              </tr>
            </thead>
            <tbody>
              ${systemLogs.map(log => `
                <tr class="border-t">
                  <td class="py-2 px-4">${new Date(log.timestamp).toLocaleTimeString()}</td>
                  <td class="py-2 px-4">
                    <span class="pill ${log.type === 'error' ? 'status-inactive' : log.type === 'warning' ? 'bg-yellow-100 text-yellow-800' : 'status-active'}">
                      ${log.type}
                    </span>
                  </td>
                  <td class="py-2 px-4">${log.message}</td>
                  <td class="py-2 px-4">${log.user}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        <div class="mt-3 flex justify-between">
          <button class="px-3 py-1 bg-gray-200 rounded" onclick="clearLogs()">Clear Logs</button>
          <button class="px-3 py-1 bg-blue-600 text-white rounded" onclick="exportLogs()">Export Logs</button>
        </div>
      </div>
    `;
  }

  // -------------------------
  // Helper Functions
  // -------------------------
  function showAddUserForm() {
    const modalContent = `
      <div class="p-4">
        <h3 class="text-xl font-bold mb-4">Add New User</h3>
        <form id="addUserForm" class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">Username</label>
            <input type="text" id="newUsername" class="w-full p-2 border rounded" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Full Name</label>
            <input type="text" id="newName" class="w-full p-2 border rounded" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Email</label>
            <input type="email" id="newEmail" class="w-full p-2 border rounded" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Role</label>
            <select id="newRole" class="w-full p-2 border rounded" required>
              <option value="">Select Role</option>
              <option value="admin">Administrator</option>
              <option value="doctor">Doctor</option>
              <option value="nurse">Nurse</option>
              <option value="pharmacist">Pharmacist</option>
              <option value="receptionist">Receptionist</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Password</label>
            <input type="password" id="newPassword" class="w-full p-2 border rounded" required>
          </div>
          
          <div class="flex justify-end space-x-2 mt-4">
            <button type="button" class="px-4 py-2 bg-gray-300 rounded" onclick="closeModal()">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Add User</button>
          </div>
        </form>
      </div>
    `;
    
    showModal(modalContent);
    
    document.getElementById('addUserForm').onsubmit = function(e) {
      e.preventDefault();
      
      const newUser = {
        id: uid('u'),
        username: document.getElementById('newUsername').value,
        name: document.getElementById('newName').value,
        email: document.getElementById('newEmail').value,
        role: document.getElementById('newRole').value,
        password: document.getElementById('newPassword').value,
        status: 'active',
        lastLogin: new Date().toISOString()
      };
      
      users.push(newUser);
      save();
      
      // Add to system logs
      systemLogs.unshift({
        id: uid('l'),
        type: 'info',
        message: `New user created: ${newUser.username}`,
        timestamp: new Date().toISOString(),
        user: 'admin'
      });
      save();
      
      closeModal();
      render('users');
    };
  }

  function editUser(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) return;
    
    const modalContent = `
      <div class="p-4">
        <h3 class="text-xl font-bold mb-4">Edit User</h3>
        <form id="editUserForm" class="space-y-3">
          <input type="hidden" id="editUserId" value="${user.id}">
          
          <div>
            <label class="block text-sm font-medium mb-1">Username</label>
            <input type="text" id="editUsername" value="${user.username}" class="w-full p-2 border rounded" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Full Name</label>
            <input type="text" id="editName" value="${user.name}" class="w-full p-2 border rounded" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Email</label>
            <input type="email" id="editEmail" value="${user.email}" class="w-full p-2 border rounded" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Role</label>
            <select id="editRole" class="w-full p-2 border rounded" required>
              <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Administrator</option>
              <option value="doctor" ${user.role === 'doctor' ? 'selected' : ''}>Doctor</option>
              <option value="nurse" ${user.role === 'nurse' ? 'selected' : ''}>Nurse</option>
              <option value="pharmacist" ${user.role === 'pharmacist' ? 'selected' : ''}>Pharmacist</option>
              <option value="receptionist" ${user.role === 'receptionist' ? 'selected' : ''}>Receptionist</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Status</label>
            <select id="editStatus" class="w-full p-2 border rounded" required>
              <option value="active" ${user.status === 'active' ? 'selected' : ''}>Active</option>
              <option value="inactive" ${user.status === 'inactive' ? 'selected' : ''}>Inactive</option>
            </select>
          </div>
          
          <div class="flex justify-end space-x-2 mt-4">
            <button type="button" class="px-4 py-2 bg-gray-300 rounded" onclick="closeModal()">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Update User</button>
          </div>
        </form>
      </div>
    `;
    
    showModal(modalContent);
    
    document.getElementById('editUserForm').onsubmit = function(e) {
      e.preventDefault();
      
      const userId = document.getElementById('editUserId').value;
      users = users.map(u => {
        if (u.id === userId) {
          return {
            ...u,
            username: document.getElementById('editUsername').value,
            name: document.getElementById('editName').value,
            email: document.getElementById('editEmail').value,
            role: document.getElementById('editRole').value,
            status: document.getElementById('editStatus').value
          };
        }
        return u;
      });
      
      save();
      
      // Add to system logs
      systemLogs.unshift({
        id: uid('l'),
        type: 'info',
        message: `User updated: ${document.getElementById('editUsername').value}`,
        timestamp: new Date().toISOString(),
        user: 'admin'
      });
      save();
      
      closeModal();
      render('users');
    };
  }

  function deleteUser(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) return;
    
    if (confirm(`Are you sure you want to delete user ${user.username}?`)) {
      users = users.filter(u => u.id !== userId);
      save();
      
      // Add to system logs
      systemLogs.unshift({
        id: uid('l'),
        type: 'warning',
        message: `User deleted: ${user.username}`,
        timestamp: new Date().toISOString(),
        user: 'admin'
      });
      save();
      
      render('users');
    }
  }

  function resetSettings() {
    if (confirm('Are you sure you want to reset all system settings to defaults?')) {
      systemSettings = {
        hospitalName: 'Ministry of Health Hospital',
        location: 'Windhoek, Namibia',
        contactEmail: 'info@moh.gov',
        contactPhone: '+264 61 123 4567',
        workingHours: '08:00 - 17:00',
        emergencyContact: '+264 81 123 4567',
        systemMaintenance: false,
        backupFrequency: 'daily'
      };
      
      save();
      alert('System settings reset to defaults');
      render('system');
    }
  }

  function backupDatabase() {
    // Simulate backup process
    alert('Database backup initiated. This may take a few moments...');
    
    setTimeout(() => {
      // Add to system logs
      systemLogs.unshift({
        id: uid('l'),
        type: 'info',
        message: 'Database backup completed successfully',
        timestamp: new Date().toISOString(),
        user: 'system'
      });
      save();
      
      alert('Database backup completed successfully');
    }, 2000);
  }

  function restoreDatabase() {
    alert('Database restore functionality would be implemented here');
  }

  function clearLogs() {
    if (confirm('Are you sure you want to clear all system logs?')) {
      systemLogs = [];
      save();
      render('database');
    }
  }

  function exportLogs() {
    alert('System logs export functionality would be implemented here');
  }

  function exportReport(type) {
    alert(`${type} report export functionality would be implemented here`);
  }

  function showSystemStatus() {
    const modalContent = `
      <div class="p-4">
        <h3 class="text-xl font-bold mb-4">System Status</h3>
        <div class="space-y-3">
          <div class="flex justify-between">
            <div>Server Status</div>
            <div class="font-semibold text-green-600">Online</div>
          </div>
          <div class="flex justify-between">
            <div>Database Status</div>
            <div class="font-semibold text-green-600">Connected</div>
          </div>
          <div class="flex justify-between">
            <div>Last Backup</div>
            <div class="font-semibold">${fmtDate(new Date())}</div>
          </div>
          <div class="flex justify-between">
            <div>Active Users</div>
            <div class="font-semibold">${users.filter(u => u.status === 'active').length}</div>
          </div>
          <div class="flex justify-between">
            <div>System Uptime</div>
            <div class="font-semibold">15 days, 4 hours</div>
          </div>
        </div>
        
        <div class="mt-6 flex justify-end">
          <button class="px-4 py-2 bg-gray-300 rounded" onclick="closeModal()">Close</button>
        </div>
      </div>
    `;
    
    showModal(modalContent);
  }

  // -------------------------
  // Modal Functions
  // -------------------------
  function showModal(content) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
      <div class="bg-white rounded-lg shadow-lg max-w-md w-full max-h-[90vh] overflow-y-auto">
        ${content}
      </div>
    `;
    
    modal.id = 'customModal';
    document.body.appendChild(modal);
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeModal();
      }
    });
  }

  function closeModal() {
    const modal = document.getElementById('customModal');
    if (modal) {
      document.body.removeChild(modal);
    }
  }

  // -------------------------
  // Dispatcher
  // -------------------------
  function render(page){
    switch(page){
      case 'dashboard': renderDashboard(); break;
      case 'users': renderUsers(); break;
      case 'system': renderSystem(); break;
      case 'analytics': renderAnalytics(); break;
      case 'database': renderDatabase(); break;
      default: renderDashboard();
    }
    highlightNav(page);
  }

  function highlightNav(page){
    ['nav-dashboard','nav-users','nav-system','nav-analytics','nav-database'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.classList.remove('bg-gray-100','font-semibold');
    });
    switch(page){
      case 'dashboard': document.getElementById('nav-dashboard').classList.add('bg-gray-100','font-semibold'); break;
      case 'users': document.getElementById('nav-users').classList.add('bg-gray-100','font-semibold'); break;
      case 'system': document.getElementById('nav-system').classList.add('bg-gray-100','font-semibold'); break;
      case 'analytics': document.getElementById('nav-analytics').classList.add('bg-gray-100','font-semibold'); break;
      case 'database': document.getElementById('nav-database').classList.add('bg-gray-100','font-semibold'); break;
    }
  }

  // init
  render('dashboard');
  document.getElementById('logoutBtn').onclick=()=>{ 
    if(confirm('Logout?')) {
      // Clear any stored user data
      localStorage.removeItem('currentUser');
      sessionStorage.removeItem('currentUser');
      window.location.href = 'login.html'; 
    } 
  };
  
  // Add event listener for the Dashboard button
  document.getElementById('dashboardBtn').onclick=()=>{ 
    window.location.href = 'index.html'; 
  };

  // expose
  window.render=render;
  window.showAddUserForm=showAddUserForm;
  window.editUser=editUser;
  window.deleteUser=deleteUser;
  window.resetSettings=resetSettings;
  window.backupDatabase=backupDatabase;
  window.restoreDatabase=restoreDatabase;
  window.clearLogs=clearLogs;
  window.exportLogs=exportLogs;
  window.exportReport=exportReport;
  window.showSystemStatus=showSystemStatus;
  window.closeModal=closeModal;
  </script>
</body>
</html>