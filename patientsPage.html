<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MESMTF ‚Äî Pharmacist Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in { animation: fadeIn .3s ease-in; }
    @keyframes fadeIn { from {opacity:0; transform:translateY(6px);} to {opacity:1; transform:translateY(0);} }
    .pill { display:inline-block; padding:.25rem .6rem; border-radius:999px; background:#eef2ff; color:#312e81; font-size:.8rem; }
    .small { font-size:.85rem; }
    .status-pending { background:#fef3c7; color:#92400e; }
    .status-filled { background:#d1fae5; color:#065f46; }
    .status-out-of-stock { background:#fee2e2; color:#991b1b; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

  <!-- Top nav -->
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto flex items-center justify-between p-4">
      <div class="flex items-center space-x-4">
        <div class="rounded-full bg-purple-600 w-12 h-12 flex items-center justify-center text-white font-bold">P</div>
        <div>
          <div class="text-lg font-bold text-gray-800">MESMTF Pharmacist Portal</div>
          <div class="text-sm text-gray-500">Medical Expert System ‚Äî Malaria & Typhoid</div>
        </div>
      </div>
      <div class="flex items-center space-x-4">
        <div class="text-sm text-gray-700">Pharmacist Mike ‚Ä¢ <span class="text-xs text-gray-500">Pharmacist</span></div>
        <button id="dashboardBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded mr-2">Dashboard</button>
        <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">Logout</button>
      </div>
    </div>
  </header>

  <div class="max-w-7xl mx-auto mt-6 flex gap-6 px-4">
    <!-- Sidebar -->
    <aside class="w-72 bg-white rounded-lg shadow p-4 sticky top-6 h-[calc(100vh-96px)]">
      <nav class="space-y-1">
        <button id="nav-dashboard" class="w-full text-left px-3 py-2 rounded hover:bg-gray-50" onclick="render('dashboard')">üè† Dashboard</button>
        <button id="nav-prescriptions" class="w-full text-left px-3 py-2 rounded hover:bg-gray-50" onclick="render('prescriptions')">üìã Pending Prescriptions</button>
        <button id="nav-inventory" class="w-full text-left px-3 py-2 rounded hover:bg-gray-50" onclick="render('inventory')">üì¶ Drug Inventory</button>
        <button id="nav-dispensary" class="w-full text-left px-3 py-2 rounded hover:bg-gray-50" onclick="render('dispensary')">üíä Dispensary</button>
        <button id="nav-reports" class="w-full text-left px-3 py-2 rounded hover:bg-gray-50" onclick="render('reports')">üìä Reports</button>
      </nav>
    </aside>

    <!-- Main content -->
    <main id="mainContent" class="flex-1 min-h-[70vh] bg-white rounded-lg shadow p-6 fade-in">
    </main>
  </div>

  <script>
  // -------------------------
  // Data
  // -------------------------
  let prescriptions = JSON.parse(localStorage.getItem('pharmacist_prescriptions')) || [
    { 
      id: 'rx1', 
      patientId: 'p1', 
      patientName: 'John Doe', 
      doctorName: 'Dr. Smith',
      diagnosis: 'Malaria',
      medications: [
        { name: 'Artemether-Lumefantrine', dosage: '80/480mg', frequency: 'Twice daily', duration: '3 days', status: 'pending' },
        { name: 'Paracetamol', dosage: '500mg', frequency: 'As needed for fever', duration: '5 days', status: 'pending' }
      ],
      date: new Date().toISOString(),
      status: 'pending'
    },
    { 
      id: 'rx2', 
      patientId: 'p2', 
      patientName: 'Jane Smith', 
      doctorName: 'Dr. Johnson',
      diagnosis: 'Typhoid Fever',
      medications: [
        { name: 'Ciprofloxacin', dosage: '500mg', frequency: 'Twice daily', duration: '10 days', status: 'pending' }
      ],
      date: new Date(Date.now() - 86400000).toISOString(),
      status: 'pending'
    }
  ];
  
  let inventory = JSON.parse(localStorage.getItem('pharmacist_inventory')) || [
    { id: 'i1', name: 'Artemether-Lumefantrine', category: 'Antimalarial', stock: 150, minStock: 20, unit: 'tablets' },
    { id: 'i2', name: 'Chloroquine', category: 'Antimalarial', stock: 80, minStock: 15, unit: 'tablets' },
    { id: 'i3', name: 'Ciprofloxacin', category: 'Antibiotic', stock: 200, minStock: 30, unit: 'tablets' },
    { id: 'i4', name: 'Azithromycin', category: 'Antibiotic', stock: 120, minStock: 25, unit: 'tablets' },
    { id: 'i5', name: 'Paracetamol', category: 'Analgesic', stock: 500, minStock: 100, unit: 'tablets' },
    { id: 'i6', name: 'IV Quinine', category: 'Antimalarial', stock: 25, minStock: 10, unit: 'vials' }
  ];
  
  let dispensed = JSON.parse(localStorage.getItem('pharmacist_dispensed')) || [];
  
  function save(){ 
    localStorage.setItem('pharmacist_prescriptions', JSON.stringify(prescriptions)); 
    localStorage.setItem('pharmacist_inventory', JSON.stringify(inventory)); 
    localStorage.setItem('pharmacist_dispensed', JSON.stringify(dispensed)); 
  }

  function uid(prefix){ return prefix+'-'+Math.floor(Date.now()+Math.random()*1000); }
  function fmtDate(d){ return new Date(d).toLocaleString(); }

  // -------------------------
  // Dashboard
  // -------------------------
  function renderDashboard(){
    const pendingPrescriptions = prescriptions.filter(p => p.status === 'pending').length;
    const lowStockItems = inventory.filter(i => i.stock <= i.minStock).length;
    const todayDispensed = dispensed.filter(d => {
      const today = new Date().toDateString();
      return new Date(d.dispenseDate).toDateString() === today;
    }).length;
    
    document.getElementById('mainContent').innerHTML = `
      <h2 class="text-2xl font-bold mb-4">Pharmacist Dashboard</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white p-4 rounded shadow border-l-4 border-blue-500">
          <h3 class="text-sm text-gray-500">Pending Prescriptions</h3>
          <div class="text-lg font-semibold mt-2">${pendingPrescriptions}</div>
        </div>
        <div class="bg-white p-4 rounded shadow border-l-4 border-red-500">
          <h3 class="text-sm text-gray-500">Low Stock Items</h3>
          <div class="text-lg font-semibold mt-2">${lowStockItems}</div>
        </div>
        <div class="bg-white p-4 rounded shadow border-l-4 border-green-500">
          <h3 class="text-sm text-gray-500">Dispensed Today</h3>
          <div class="text-lg font-semibold mt-2">${todayDispensed}</div>
        </div>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="font-semibold mb-3">Recent Prescriptions</h3>
          <div class="space-y-2">
            ${prescriptions.slice(0, 3).map(p => `
              <div class="p-2 border rounded">
                <div class="font-semibold">${p.patientName}</div>
                <div class="text-xs text-gray-500">${p.diagnosis} ‚Ä¢ ${fmtDate(p.date)}</div>
                <div class="text-xs mt-1">
                  <span class="pill ${p.status === 'pending' ? 'status-pending' : 'status-filled'}">${p.status}</span>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="font-semibold mb-3">Low Stock Alert</h3>
          <div class="space-y-2">
            ${inventory.filter(i => i.stock <= i.minStock).slice(0, 3).map(i => `
              <div class="p-2 border rounded">
                <div class="font-semibold">${i.name}</div>
                <div class="text-xs text-gray-500">Stock: ${i.stock} ${i.unit} ‚Ä¢ Min: ${i.minStock}</div>
                <div class="text-xs mt-1">
                  <span class="pill status-out-of-stock">Low Stock</span>
                </div>
              </div>
            `).join('')}
            ${inventory.filter(i => i.stock <= i.minStock).length === 0 ? 
              '<div class="text-center text-gray-500 py-4">All items are sufficiently stocked</div>' : ''}
          </div>
        </div>
      </div>
    `;
  }

  // -------------------------
  // Prescriptions
  // -------------------------
  function renderPrescriptions(){
    const pending = prescriptions.filter(p => p.status === 'pending');
    
    document.getElementById('mainContent').innerHTML = `
      <h2 class="text-2xl font-bold mb-4">Pending Prescriptions</h2>
      <div class="space-y-4">
        ${pending.length > 0 ? pending.map(p => `
          <div class="p-4 border rounded-lg">
            <div class="flex justify-between items-start mb-3">
              <div>
                <div class="font-semibold text-lg">${p.patientName}</div>
                <div class="text-sm text-gray-600">Diagnosis: ${p.diagnosis}</div>
                <div class="text-xs text-gray-500">Prescribed by: ${p.doctorName} ‚Ä¢ ${fmtDate(p.date)}</div>
              </div>
              <span class="pill status-pending">Pending</span>
            </div>
            
            <div class="mb-4">
              <h4 class="font-medium mb-2">Medications:</h4>
              <div class="space-y-2">
                ${p.medications.map(m => `
                  <div class="p-2 bg-gray-50 rounded">
                    <div class="font-medium">${m.name} ‚Ä¢ ${m.dosage}</div>
                    <div class="text-xs text-gray-600">${m.frequency} for ${m.duration}</div>
                    <div class="text-xs mt-1">
                      <span class="pill ${m.status === 'pending' ? 'status-pending' : 'status-filled'}">${m.status}</span>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div class="flex justify-end space-x-2">
              <button class="px-4 py-2 bg-blue-600 text-white rounded" onclick="dispensePrescription('${p.id}')">Dispense All</button>
              <button class="px-4 py-2 bg-gray-200 text-gray-800 rounded" onclick="viewPrescriptionDetails('${p.id}')">Details</button>
            </div>
          </div>
        `).join('') : 
        '<div class="text-center py-8 text-gray-500">No pending prescriptions</div>'}
      </div>
    `;
  }

  // -------------------------
  // Inventory
  // -------------------------
  function renderInventory(){
    document.getElementById('mainContent').innerHTML = `
      <h2 class="text-2xl font-bold mb-4">Drug Inventory</h2>
      
      <div class="mb-4 flex justify-between">
        <input type="text" id="searchInventory" placeholder="Search drugs..." class="p-2 border rounded w-64">
        <button class="px-4 py-2 bg-green-600 text-white rounded" onclick="showAddDrugForm()">Add New Drug</button>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white border">
          <thead>
            <tr class="bg-gray-100">
              <th class="py-2 px-4 border text-left">Drug Name</th>
              <th class="py-2 px-4 border text-left">Category</th>
              <th class="py-2 px-4 border text-left">Current Stock</th>
              <th class="py-2 px-4 border text-left">Min Stock</th>
              <th class="py-2 px-4 border text-left">Status</th>
              <th class="py-2 px-4 border text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="inventoryTable">
            ${inventory.map(i => `
              <tr class="${i.stock <= i.minStock ? 'bg-red-50' : ''}">
                <td class="py-2 px-4 border">${i.name}</td>
                <td class="py-2 px-4 border">${i.category}</td>
                <td class="py-2 px-4 border">${i.stock} ${i.unit}</td>
                <td class="py-2 px-4 border">${i.minStock} ${i.unit}</td>
                <td class="py-2 px-4 border">
                  <span class="pill ${i.stock <= i.minStock ? 'status-out-of-stock' : 'status-filled'}">
                    ${i.stock <= i.minStock ? 'Low Stock' : 'In Stock'}
                  </span>
                </td>
                <td class="py-2 px-4 border">
                  <button class="text-blue-600 hover:underline mr-2" onclick="updateStock('${i.id}')">Update Stock</button>
                  <button class="text-red-600 hover:underline" onclick="deleteDrug('${i.id}')">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
    
    // Add search functionality
    document.getElementById('searchInventory').addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#inventoryTable tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });
  }

  // -------------------------
  // Dispensary
  // -------------------------
  function renderDispensary(){
    const today = new Date().toDateString();
    const todayDispensed = dispensed.filter(d => new Date(d.dispenseDate).toDateString() === today);
    
    document.getElementById('mainContent').innerHTML = `
      <h2 class="text-2xl font-bold mb-4">Dispensary</h2>
      
      <div class="mb-6">
        <h3 class="font-semibold mb-2">Today's Dispensed Medications</h3>
        <div class="space-y-2">
          ${todayDispensed.length > 0 ? todayDispensed.map(d => `
            <div class="p-3 border rounded">
              <div class="font-semibold">${d.patientName}</div>
              <div class="text-sm">${d.medication} ‚Ä¢ ${d.dosage}</div>
              <div class="text-xs text-gray-500">Dispensed by: ${d.pharmacist} ‚Ä¢ ${fmtDate(d.dispenseDate)}</div>
            </div>
          `).join('') : 
          '<div class="text-center py-4 text-gray-500">No medications dispensed today</div>'}
        </div>
      </div>
      
      <div>
        <h3 class="font-semibold mb-2">Dispense Medication</h3>
        <form id="dispenseForm" class="space-y-3 bg-gray-50 p-4 rounded max-w-md">
          <div>
            <label class="block text-sm font-medium mb-1">Patient</label>
            <select id="dispensePatient" class="w-full p-2 border rounded" required>
              <option value="">Select Patient</option>
              ${[...new Set(prescriptions.map(p => p.patientId))].map(pid => {
                const patient = prescriptions.find(p => p.patientId === pid);
                return `<option value="${pid}">${patient.patientName}</option>`;
              }).join('')}
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Medication</label>
            <select id="dispenseMedication" class="w-full p-2 border rounded" required>
              <option value="">Select Medication</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Quantity</label>
            <input type="number" id="dispenseQuantity" class="w-full p-2 border rounded" min="1" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Instructions</label>
            <textarea id="dispenseInstructions" class="w-full p-2 border rounded" rows="2"></textarea>
          </div>
          
          <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Dispense</button>
        </form>
      </div>
    `;
    
    // Update medications based on selected patient
    document.getElementById('dispensePatient').addEventListener('change', function() {
      const patientId = this.value;
      const medicationSelect = document.getElementById('dispenseMedication');
      medicationSelect.innerHTML = '<option value="">Select Medication</option>';
      
      if (patientId) {
        const patientPrescriptions = prescriptions.filter(p => p.patientId === patientId && p.status === 'pending');
        patientPrescriptions.forEach(p => {
          p.medications.forEach(m => {
            if (m.status === 'pending') {
              const option = document.createElement('option');
              option.value = m.name;
              option.textContent = `${m.name} - ${m.dosage}`;
              medicationSelect.appendChild(option);
            }
          });
        });
      }
    });
    
    document.getElementById('dispenseForm').onsubmit = function(e) {
      e.preventDefault();
      const patientId = document.getElementById('dispensePatient').value;
      const medication = document.getElementById('dispenseMedication').value;
      const quantity = document.getElementById('dispenseQuantity').value;
      const instructions = document.getElementById('dispenseInstructions').value;
      
      if (!patientId || !medication || !quantity) {
        alert('Please fill all required fields');
        return;
      }
      
      const patient = prescriptions.find(p => p.patientId === patientId);
      const dispenseRecord = {
        id: uid('disp'),
        patientId,
        patientName: patient.patientName,
        medication,
        dosage: medication.split(' - ')[1] || '',
        quantity,
        instructions,
        dispenseDate: new Date().toISOString(),
        pharmacist: 'Pharmacist Mike'
      };
      
      dispensed.push(dispenseRecord);
      
      // Update prescription status
      prescriptions = prescriptions.map(p => {
        if (p.patientId === patientId) {
          const updatedMeds = p.medications.map(m => {
            if (m.name === medication.split(' - ')[0]) {
              return { ...m, status: 'filled' };
            }
            return m;
          });
          
          // Check if all medications are filled
          const allFilled = updatedMeds.every(m => m.status === 'filled');
          
          return {
            ...p,
            medications: updatedMeds,
            status: allFilled ? 'filled' : 'pending'
          };
        }
        return p;
      });
      
      // Update inventory
      const drugName = medication.split(' - ')[0];
      const drugIndex = inventory.findIndex(i => i.name === drugName);
      if (drugIndex !== -1) {
        inventory[drugIndex].stock -= parseInt(quantity);
      }
      
      save();
      alert('Medication dispensed successfully');
      render('dispensary');
    };
  }

  // -------------------------
  // Reports
  // -------------------------
  function renderReports(){
    const monthlyDispensed = dispensed.filter(d => {
      const dispenseDate = new Date(d.dispenseDate);
      const now = new Date();
      return dispenseDate.getMonth() === now.getMonth() && dispenseDate.getFullYear() === now.getFullYear();
    }).length;
    
    const lowStockCount = inventory.filter(i => i.stock <= i.minStock).length;
    const totalInventoryValue = inventory.reduce((sum, i) => {
      // Simple estimation - in real app would have actual prices
      const estimatedPrice = i.category === 'Antimalarial' ? 5 : i.category === 'Antibiotic' ? 3 : 1;
      return sum + (i.stock * estimatedPrice);
    }, 0);
    
    document.getElementById('mainContent').innerHTML = `
      <h2 class="text-2xl font-bold mb-4">Pharmacy Reports</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white p-4 rounded shadow">
          <h3 class="text-sm text-gray-500">Monthly Dispensed</h3>
          <div class="text-lg font-semibold mt-2">${monthlyDispensed}</div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <h3 class="text-sm text-gray-500">Low Stock Items</h3>
          <div class="text-lg font-semibold mt-2">${lowStockCount}</div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <h3 class="text-sm text-gray-500">Inventory Value</h3>
          <div class="text-lg font-semibold mt-2">$${totalInventoryValue}</div>
        </div>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="font-semibold mb-3">Most Dispensed Drugs</h3>
          <div class="space-y-2">
            ${getTopDispensedDrugs().map(drug => `
              <div class="flex justify-between p-2 border rounded">
                <div>${drug.name}</div>
                <div class="font-semibold">${drug.count} times</div>
              </div>
            `).join('')}
          </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="font-semibold mb-3">Inventory Status</h3>
          <div class="space-y-2">
            ${inventory.slice(0, 5).map(i => `
              <div class="flex justify-between p-2 border rounded">
                <div>${i.name}</div>
                <div class="font-semibold ${i.stock <= i.minStock ? 'text-red-600' : 'text-green-600'}">
                  ${i.stock} ${i.unit}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function getTopDispensedDrugs() {
    const drugCounts = {};
    dispensed.forEach(d => {
      const drugName = d.medication.split(' - ')[0];
      drugCounts[drugName] = (drugCounts[drugName] || 0) + 1;
    });
    
    return Object.entries(drugCounts)
      .map(([name, count]) => ({ name, count }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 5);
  }

  // -------------------------
  // Helper Functions
  // -------------------------
  function dispensePrescription(prescriptionId) {
    const prescription = prescriptions.find(p => p.id === prescriptionId);
    if (!prescription) return;
    
    // Check inventory for all medications
    const canDispense = prescription.medications.every(m => {
      const drug = inventory.find(i => i.name === m.name);
      return drug && drug.stock > 0;
    });
    
    if (!canDispense) {
      alert('Cannot dispense prescription. Some medications are out of stock.');
      return;
    }
    
    // Dispense each medication
    prescription.medications.forEach(m => {
      const drugIndex = inventory.findIndex(i => i.name === m.name);
      if (drugIndex !== -1) {
        // Estimate quantity needed (simplified)
        const quantity = m.duration.includes('day') ? 
          parseInt(m.duration) * (m.frequency.includes('Twice') ? 2 : 1) : 10;
        
        inventory[drugIndex].stock -= quantity;
        
        // Add to dispensed records
        dispensed.push({
          id: uid('disp'),
          patientId: prescription.patientId,
          patientName: prescription.patientName,
          medication: m.name,
          dosage: m.dosage,
          quantity,
          instructions: `${m.frequency} for ${m.duration}`,
          dispenseDate: new Date().toISOString(),
          pharmacist: 'Pharmacist Mike'
        });
        
        m.status = 'filled';
      }
    });
    
    prescription.status = 'filled';
    save();
    alert('Prescription dispensed successfully');
    render('prescriptions');
  }

  function viewPrescriptionDetails(prescriptionId) {
    const prescription = prescriptions.find(p => p.id === prescriptionId);
    if (!prescription) return;
    
    const modalContent = `
      <div class="p-4">
        <h3 class="text-xl font-bold mb-4">Prescription Details</h3>
        <div class="space-y-3">
          <div><strong>Patient:</strong> ${prescription.patientName}</div>
          <div><strong>Diagnosis:</strong> ${prescription.diagnosis}</div>
          <div><strong>Prescribing Doctor:</strong> ${prescription.doctorName}</div>
          <div><strong>Date:</strong> ${fmtDate(prescription.date)}</div>
          
          <div class="mt-4">
            <h4 class="font-semibold mb-2">Medications:</h4>
            ${prescription.medications.map(m => `
              <div class="p-2 bg-gray-50 rounded mb-2">
                <div class="font-medium">${m.name} ‚Ä¢ ${m.dosage}</div>
                <div class="text-sm">${m.frequency} for ${m.duration}</div>
                <div class="text-xs mt-1">
                  <span class="pill ${m.status === 'pending' ? 'status-pending' : 'status-filled'}">${m.status}</span>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
        
        <div class="mt-6 flex justify-end">
          <button class="px-4 py-2 bg-gray-300 rounded" onclick="closeModal()">Close</button>
        </div>
      </div>
    `;
    
    showModal(modalContent);
  }

  function updateStock(drugId) {
    const drug = inventory.find(i => i.id === drugId);
    if (!drug) return;
    
    const newStock = prompt(`Enter new stock quantity for ${drug.name}:`, drug.stock);
    if (newStock !== null && !isNaN(newStock) && newStock >= 0) {
      drug.stock = parseInt(newStock);
      save();
      render('inventory');
    }
  }

  function deleteDrug(drugId) {
    if (confirm('Are you sure you want to delete this drug from inventory?')) {
      inventory = inventory.filter(i => i.id !== drugId);
      save();
      render('inventory');
    }
  }

  function showAddDrugForm() {
    const modalContent = `
      <div class="p-4">
        <h3 class="text-xl font-bold mb-4">Add New Drug to Inventory</h3>
        <form id="addDrugForm" class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">Drug Name</label>
            <input type="text" id="newDrugName" class="w-full p-2 border rounded" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Category</label>
            <select id="newDrugCategory" class="w-full p-2 border rounded" required>
              <option value="">Select Category</option>
              <option value="Antimalarial">Antimalarial</option>
              <option value="Antibiotic">Antibiotic</option>
              <option value="Analgesic">Analgesic</option>
              <option value="Other">Other</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Initial Stock</label>
            <input type="number" id="newDrugStock" class="w-full p-2 border rounded" min="0" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Minimum Stock Level</label>
            <input type="number" id="newDrugMinStock" class="w-full p-2 border rounded" min="0" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Unit</label>
            <input type="text" id="newDrugUnit" class="w-full p-2 border rounded" value="tablets" required>
          </div>
          
          <div class="flex justify-end space-x-2 mt-4">
            <button type="button" class="px-4 py-2 bg-gray-300 rounded" onclick="closeModal()">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Add Drug</button>
          </div>
        </form>
      </div>
    `;
    
    showModal(modalContent);
    
    document.getElementById('addDrugForm').onsubmit = function(e) {
      e.preventDefault();
      
      const newDrug = {
        id: uid('i'),
        name: document.getElementById('newDrugName').value,
        category: document.getElementById('newDrugCategory').value,
        stock: parseInt(document.getElementById('newDrugStock').value),
        minStock: parseInt(document.getElementById('newDrugMinStock').value),
        unit: document.getElementById('newDrugUnit').value
      };
      
      inventory.push(newDrug);
      save();
      closeModal();
      render('inventory');
    };
  }

  // -------------------------
  // Modal Functions
  // -------------------------
  function showModal(content) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
      <div class="bg-white rounded-lg shadow-lg max-w-md w-full max-h-[90vh] overflow-y-auto">
        ${content}
      </div>
    `;
    
    modal.id = 'customModal';
    document.body.appendChild(modal);
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeModal();
      }
    });
  }

  function closeModal() {
    const modal = document.getElementById('customModal');
    if (modal) {
      document.body.removeChild(modal);
    }
  }

  // -------------------------
  // Dispatcher
  // -------------------------
  function render(page){
    switch(page){
      case 'dashboard': renderDashboard(); break;
      case 'prescriptions': renderPrescriptions(); break;
      case 'inventory': renderInventory(); break;
      case 'dispensary': renderDispensary(); break;
      case 'reports': renderReports(); break;
      default: renderDashboard();
    }
    highlightNav(page);
  }

  function highlightNav(page){
    ['nav-dashboard','nav-prescriptions','nav-inventory','nav-dispensary','nav-reports'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.classList.remove('bg-gray-100','font-semibold');
    });
    switch(page){
      case 'dashboard': document.getElementById('nav-dashboard').classList.add('bg-gray-100','font-semibold'); break;
      case 'prescriptions': document.getElementById('nav-prescriptions').classList.add('bg-gray-100','font-semibold'); break;
      case 'inventory': document.getElementById('nav-inventory').classList.add('bg-gray-100','font-semibold'); break;
      case 'dispensary': document.getElementById('nav-dispensary').classList.add('bg-gray-100','font-semibold'); break;
      case 'reports': document.getElementById('nav-reports').classList.add('bg-gray-100','font-semibold'); break;
    }
  }

  // init
  render('dashboard');
  document.getElementById('logoutBtn').onclick=()=>{ 
    if(confirm('Logout?')) {
      // Clear any stored user data
      localStorage.removeItem('currentUser');
      sessionStorage.removeItem('currentUser');
      window.location.href = 'login.html'; 
    } 
  };
  
  // Add event listener for the Dashboard button
  document.getElementById('dashboardBtn').onclick=()=>{ 
    window.location.href = 'index.html'; 
  };

  // expose
  window.render=render;
  window.dispensePrescription=dispensePrescription;
  window.viewPrescriptionDetails=viewPrescriptionDetails;
  window.updateStock=updateStock;
  window.deleteDrug=deleteDrug;
  window.showAddDrugForm=showAddDrugForm;
  window.closeModal=closeModal;
  </script>
</body>
</html>